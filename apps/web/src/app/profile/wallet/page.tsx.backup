"use client";

import { useEffect, useState, Suspense, useRef, useCallback } from "react";
import { useSearchParams } from "next/navigation";

// Simple debounce function
const debounce = (func: Function, wait: number) => {
  let timeout: NodeJS.Timeout;
  return function executedFunction(...args: any[]) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};
import {
  Wallet,
  ArrowUpRight,
  ArrowDownLeft,
  History,
  CreditCard,
  TrendingUp,
  Eye,
  EyeOff,
  Plus,
  Minus,
  RefreshCw,
  AlertCircle,
  CheckCircle,
  Clock,
  XCircle,
  QrCode,
  Camera,
  UserPlus,
  Download,
  Filter,
  SortAsc,
  SortDesc,
  ChevronDown,
  ChevronLeft,
  ChevronRight,
  X,
  Search,
  BarChart3
} from "lucide-react";

// TypeScript: declare custom window flag used as a single-start guard
declare global {
  interface Window {
    __transferStartedRef?: { started: boolean };
  }
}
import Link from "next/link";
import { RequireAuth } from "@/components/auth/Guards";
import { apiGet, apiPost, getAuthHeader } from "@/utils/api";
import { getUserId } from "@/utils/auth";
import Modal from "@/components/common/Modal";
import { toast } from "@/components/common/Toast";
import { useRealTimeNotifications } from "@/hooks/useRealTimeNotifications";

interface WalletBalance {
  available: number;
  frozen: number;
  total: number;
  currency: "ATH" | "NGN";
}

interface WalletSummary {
  ngnWallet: WalletBalance;
  totalValue: number;
}

interface Transaction {
  _id: string;
  type: string;
  category: string;
  amount: number;
  currency: string;
  balanceBefore: number;
  balanceAfter: number;
  status: string;
  reference: string;
  description: string;
  createdAt: string;
}

function WalletPageContent() {
  const searchParams = useSearchParams();
  const [walletSummary, setWalletSummary] = useState<WalletSummary | null>(null);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showBalance, setShowBalance] = useState(true);
  const [showTopUpModal, setShowTopUpModal] = useState(false);
  const [showSuccessMessage, setShowSuccessMessage] = useState(false);

  // Real-time wallet updates
  const { isConnected } = useRealTimeNotifications({
    onWalletBalanceUpdate: (data) => {
      if (walletSummary && data.currency === 'NGN') {
        setWalletSummary(prev => {
          if (!prev) return null;

          return {
            ...prev,
            ngnWallet: {
              available: data.available,
              frozen: data.frozen,
              total: data.total,
              currency: 'NGN'
            }
          };
        });
      }
    },
    onWalletTransactionUpdate: (data) => {
      // Add new transaction to the top of the list
      const newTransaction: Transaction = {
        _id: data.transactionId,
        type: data.type,
        category: data.type,
        amount: data.amount,
        currency: data.currency,
        status: data.status,
        reference: `TXN_${data.transactionId.slice(-8)}`,
        description: data.description,
        createdAt: data.createdAt.toISOString(),
        balanceBefore: 0, // Will be updated when we have the actual balance
        balanceAfter: 0   // Will be updated when we have the actual balance
      };

      setTransactions(prev => [newTransaction, ...prev.slice(0, 9)]); // Keep only 10 most recent

      // Show toast notification
      toast(`New ${data.type} transaction: ${data.description}`, "success");
    },
    onWalletStatusUpdate: (data) => {
      if (data.status === 'frozen') {
        toast(`Your wallet has been frozen: ${data.reason}`, "error");
      } else if (data.status === 'active') {
        toast("Your wallet has been unfrozen", "success");
      }
    }
  });

  // Enhanced transaction history states
  const [transactionFilters, setTransactionFilters] = useState({
    search: "",
    currency: "all",
    transactionType: "all",
    status: "all",
    startDate: "",
    endDate: "",
    minAmount: "",
    maxAmount: "",
    sortBy: "createdAt",
    sortOrder: "desc"
  });
  const [transactionSummary, setTransactionSummary] = useState({
    totalAmount: 0,
    depositCount: 0,
    withdrawalCount: 0,
    transferCount: 0,
    pendingCount: 0
  });
  const [showTransactionFilters, setShowTransactionFilters] = useState(false);
  const [transactionPagination, setTransactionPagination] = useState({
    page: 1,
    total: 0,
    pages: 0
  });
  const [showTransferModal, setShowTransferModal] = useState(false);
  const [topUpAmount, setTopUpAmount] = useState("");
  const [transferData, setTransferData] = useState({
    toUserId: "",
    amount: "",
    currency: "NGN" as "ATH" | "NGN",
    description: ""
  });

  const [selectedTransaction, setSelectedTransaction] = useState<Transaction | null>(null);
  const [showTransactionDetails, setShowTransactionDetails] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const [exportFormat, setExportFormat] = useState("csv");
  const [exportStartDate, setExportStartDate] = useState("");
  const [exportEndDate, setExportEndDate] = useState("");
  const [exportType, setExportType] = useState("all");
  const [exportCurrency, setExportCurrency] = useState("all");

  // DEPRECATED: P2P transfer user search (disabled for wholesaler platform)
  /*
  const searchUsers = async (query: string) => {
    if (query.length < 2) {
      setSearchResults([]);
      return;
    }

    setIsSearching(true);
    try {
      const response = await apiGet(`/api/v1/wallets/search?q=${encodeURIComponent(query)}`) as { status: string; data: any[] };
      if (response.status === "success") {
        setSearchResults(response.data);
      }
    } catch (error) {
      console.error("Search error:", error);
      setSearchResults([]);
    } finally {
      setIsSearching(false);
    }
  };
  */

  // Load transactions with filters
  const loadTransactions = async (page = 1) => {
    try {
      const userId = getUserId();
      if (!userId) return;

      const params = new URLSearchParams({
        page: page.toString(),
        limit: "10"
      });

      // Add filters to params
      Object.entries(transactionFilters).forEach(([key, value]) => {
        if (value && value !== "all") {
          params.append(key, value);
        }
      });

      const response = await apiGet(`/api/v1/wallets/transactions?${params}`) as {
        data?: {
          transactions?: Transaction[];
          total?: number;
          pages?: number;
          summary?: any;
        }
      };

      if (response.data) {
        setTransactions(response.data.transactions || []);
        setTransactionPagination({
          page,
          total: response.data.total || 0,
          pages: response.data.pages || 0
        });
        if (response.data.summary) {
          setTransactionSummary(response.data.summary);
        }
      }
    } catch (error) {
      console.error("Error loading transactions:", error);
      toast("Failed to load transactions", "error");
    }
  };

  // Load wallet data
  useEffect(() => {
    const loadWalletData = async () => {
      try {
        const userId = getUserId();
        if (!userId) return;

        // Load wallet summary
        const summaryRes = await apiGet(`/api/v1/wallets/summary?userId=${userId}`) as { data?: WalletSummary };
        setWalletSummary(summaryRes.data || null);

        // Load user wallet info for QR code
        const walletInfoRes = await apiGet(`/api/v1/wallets/info?userId=${userId}`) as { data?: any };
        if (walletInfoRes.data) {
          setUserWalletId(walletInfoRes.data.walletId || "");
          setUserDisplayName(walletInfoRes.data.displayName || "");
        }

        // Load transactions with current filters
        await loadTransactions(1);

      } catch (error) {
        console.error("Error loading wallet data:", error);
        toast("Failed to load wallet data", "error");
      } finally {
        setIsLoading(false);
      }
    };

    loadWalletData();
  }, []);

  // Reload transactions when filters change
  useEffect(() => {
    if (!isLoading) {
      loadTransactions(1);
    }
  }, [transactionFilters]);

  // Handle success message from URL parameters
  useEffect(() => {
    const success = searchParams.get('success');
    if (success === 'true') {
      setShowSuccessMessage(true);
      toast("Wallet top-up successful!", "success");

      // Refresh wallet data and transactions after successful top-up
      const refreshData = async () => {
        try {
          const userId = getUserId();
          if (!userId) return;

          // Load wallet summary
          const summaryRes = await apiGet(`/api/v1/wallets/summary?userId=${userId}`) as { data?: WalletSummary };
          setWalletSummary(summaryRes.data || null);

          // Load transactions with current filters
          await loadTransactions(1);
        } catch (error) {
          console.error("Error refreshing wallet data after top-up:", error);
        }
      };

      // Refresh data immediately and after a short delay to ensure transaction is committed
      refreshData();
      setTimeout(refreshData, 2000);

      // Auto-hide success message after 5 seconds
      const timer = setTimeout(() => {
        setShowSuccessMessage(false);
      }, 5000);

      return () => clearTimeout(timer);
    }
  }, [searchParams]);

  // Handle top-up
  const handleTopUp = async () => {
    try {
      if (!topUpAmount || parseFloat(topUpAmount) <= 0) {
        toast("Please enter a valid amount", "error");
        return;
      }

      const amountInKobo = Math.round(parseFloat(topUpAmount) * 100);

      const result = await apiPost("/api/v1/wallets/topup", {
        amount: amountInKobo,
        currency: "NGN",
        provider: "paystack",
        returnUrl: `${window.location.origin}/profile/wallet/callback`
      }) as { data?: { paymentUrl: string; reference: string } };

      if (result.data?.paymentUrl) {
        window.location.href = result.data.paymentUrl;
      }
    } catch (error) {
      console.error("Error initiating top-up:", error);
      toast("Failed to initiate top-up", "error");
    }
  };

  // Handle transfer
  const handleTransfer = async () => {
    if (isTransferring) {
      console.log('Transfer already in progress, ignoring duplicate call');
      return;
    }

    try {
      setIsTransferring(true);
      console.log('Starting transfer...');

      if (!transferData.toUserId || !transferData.amount || parseFloat(transferData.amount) <= 0) {
        toast("Please fill in all required fields", "error");
        return;
      }

      const amountInKobo = transferData.currency === "NGN"
        ? Math.round(parseFloat(transferData.amount) * 100)
        : parseFloat(transferData.amount);

      // Generate idempotency key here to prevent race conditions
      const idempotencyKey = `transfer_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      console.log('Generated idempotency key:', idempotencyKey);

      await apiPost("/api/v1/wallets/transfer", {
        toUserId: transferData.toUserId,
        amount: amountInKobo,
        currency: transferData.currency,
        description: transferData.description,
        idempotencyKey: idempotencyKey
      });

      console.log('Transfer completed successfully');
      toast("Transfer completed successfully", "success");
      setShowTransferModal(false);
      setTransferData({ toUserId: "", amount: "", currency: "NGN", description: "" });
      setSelectedRecipient(null);
      setSearchQuery("");
      setSearchResults([]);

      // Refresh wallet data without full page reload
      const userId = getUserId();
      if (userId) {
        const summaryRes = await apiGet(`/api/v1/wallets/summary?userId=${userId}`) as { data?: WalletSummary };
        setWalletSummary(summaryRes.data || null);
        await loadTransactions(1);
      }
    } catch (error) {
      console.error("Error transferring funds:", error);
      toast("Failed to transfer funds", "error");
    } finally {
      setIsTransferring(false);
    }
  };

  // Handle transfer with validation
  const handleTransferWithValidation = () => {
    if (isTransferring || validationInProgressRef.current) {
      console.log('Transfer or validation already in progress, ignoring duplicate call');
      return;
    }

    console.log('Transfer validation data:', transferData);

    // More detailed validation with specific error messages
    if (!transferData.toUserId) {
      toast("Please search for and select a recipient from the dropdown", "error");
      return;
    }

    if (!transferData.amount || transferData.amount.trim() === "") {
      toast("Please enter an amount", "error");
      return;
    }

    const amount = parseFloat(transferData.amount);
    if (isNaN(amount) || amount <= 0) {
      toast("Please enter a valid amount greater than 0", "error");
      return;
    }

    const amountInKobo = transferData.currency === "NGN"
      ? Math.round(amount * 100)
      : amount;

    // Set validation in progress immediately to prevent duplicate calls
    validationInProgressRef.current = true;

    console.log('Validation passed, showing validator modal');
    setShowTransactionValidator(true);
  };

  // Debounced version of handleTransferWithValidation
  const debouncedHandleTransferWithValidation = useCallback(
    debounce(handleTransferWithValidation, 300),
    [transferData, isTransferring, validationInProgressRef.current]
  );

  // Handle validation complete
  const handleValidationComplete = (validation: any) => {
    console.log('Validation complete:', validation);
    console.log('Is valid:', validation.isValid);
    console.log('Errors:', validation.errors);
    console.log('Warnings:', validation.warnings);

    // Reset validation progress flag
    validationInProgressRef.current = false;

    // Ensure we only start one transfer per modal confirmation
    if (!window.__transferStartedRef) {
      (window as any).__transferStartedRef = { started: false };
    }
    const startedRef = (window as any).__transferStartedRef as { started: boolean };

    if (validation.isValid && !startedRef.started) {
      startedRef.started = true;
      console.log('Validation passed, proceeding with transfer (single-start guard)');
      handleTransfer();
    } else if (!validation.isValid) {
      console.log('Validation failed, showing error');
      const errorMessage = validation.errors && validation.errors.length > 0
        ? validation.errors[0]
        : "Transaction validation failed";
      toast(errorMessage, "error");
    }
    setShowTransactionValidator(false);
  };

  const handleExportTransactions = async () => {
    try {
      const params = new URLSearchParams({
        format: exportFormat,
        ...(exportStartDate && { startDate: exportStartDate }),
        ...(exportEndDate && { endDate: exportEndDate }),
        ...(exportType !== "all" && { type: exportType }),
        ...(exportCurrency !== "all" && { currency: exportCurrency })
      });

      // Use the same base URL and auth as other API calls
      // For development, use localhost; for production, use the deployed API
      const API_BASE_URL = process.env.NODE_ENV === 'development'
        ? "http://localhost:8080"
        : (process.env.NEXT_PUBLIC_API_URL || "https://afritrade-api.onrender.com");
      const url = `${API_BASE_URL}/api/v1/wallets/export/transactions?${params}`;

      // Get auth header from the same utility used by other API calls
      const authHeader = getAuthHeader();

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          ...authHeader,
        },
        credentials: 'include',
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wallet-transactions-${new Date().toISOString().split('T')[0]}.${exportFormat}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        toast("Transactions exported successfully!", "success");
        setShowExportModal(false);
      } else {
        const errorText = await response.text();
        console.error("Export failed:", response.status, errorText);
        toast("Failed to export transactions", "error");
      }
    } catch (error) {
      console.error("Export error:", error);
      toast("Failed to export transactions", "error");
    }
  };

  // Handle filter changes
  const handleFilterChange = (key: string, value: string) => {
    setTransactionFilters(prev => ({
      ...prev,
      [key]: value
    }));
  };

  // Clear all filters
  const clearFilters = () => {
    setTransactionFilters({
      search: "",
      currency: "all",
      transactionType: "all",
      status: "all",
      startDate: "",
      endDate: "",
      minAmount: "",
      maxAmount: "",
      sortBy: "createdAt",
      sortOrder: "desc"
    });
  };

  // Handle pagination
  const handlePageChange = (page: number) => {
    loadTransactions(page);
  };

  // Handle QR code scan
  const handleQRScan = (data: any) => {
    if (data.walletId) {
      setTransferData(prev => ({
        ...prev,
        toUserId: data.walletId,
        amount: data.amount ? (data.amount / 100).toString() : "",
        currency: data.currency || "NGN"
      }));
      setShowQRScanner(false);
      setShowTransferModal(true);
    }
  };

  // Handle contact selection
  const handleContactSelect = (contact: any) => {
    setTransferData(prev => ({
      ...prev,
      toUserId: contact.contactUserId,
      amount: "",
      currency: "NGN"
    }));
    setSelectedRecipient({
      _id: contact.contactUserId,
      walletId: contact.contactWalletId,
      displayName: contact.contactDisplayName,
      username: contact.contactUsername,
      email: contact.contactEmail,
      profileImage: contact.contactProfileImage,
      isVerified: contact.isVerified
    });
    setShowContactManager(false);
    setShowTransferModal(true);
  };

  // Format currency for wallet balance (backend already converts kobo to Naira)
  const formatWalletBalance = (amount: number, currency: string) => {
    if (currency === "NGN") {
      return `₦${amount.toLocaleString()}`;
    }
    return `${amount.toLocaleString()} ${currency}`;
  };

  // Format currency for transactions (stored in kobo, need to convert to Naira)
  const formatCurrency = (amount: number, currency: string) => {
    if (currency === "NGN") {
      return `₦${(amount / 100).toLocaleString()}`;
    }
    return `${amount.toLocaleString()} ${currency}`;
  };

  // Get transaction icon
  const getTransactionIcon = (type: string, category?: string) => {
    // Special handling for vendor payments
    if (type === "deposit" && category === "vendor_payment") {
      return <TrendingUp className="w-4 h-4 text-emerald-500" />;
    }

    switch (type) {
      case "deposit": return <ArrowDownLeft className="w-4 h-4 text-green-500" />;
      case "withdrawal": return <ArrowUpRight className="w-4 h-4 text-red-500" />;
      case "payment": return <CreditCard className="w-4 h-4 text-blue-500" />;
      case "refund": return <RefreshCw className="w-4 h-4 text-orange-500" />;
      case "transfer": return <ArrowUpRight className="w-4 h-4 text-purple-500" />;
      case "earning": return <TrendingUp className="w-4 h-4 text-green-500" />;
      default: return <Wallet className="w-4 h-4 text-gray-500" />;
    }
  };

  // Get transaction status icon
  const getStatusIcon = (status: string) => {
    switch (status) {
      case "completed": return <CheckCircle className="w-4 h-4 text-green-500" />;
      case "pending": return <Clock className="w-4 h-4 text-yellow-500" />;
      case "failed": return <XCircle className="w-4 h-4 text-red-500" />;
      case "cancelled": return <XCircle className="w-4 h-4 text-gray-500" />;
      default: return <AlertCircle className="w-4 h-4 text-gray-500" />;
    }
  };

  if (isLoading) {
    return (
      <RequireAuth>
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
          <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div className="animate-pulse space-y-6">
              <div className="h-8 bg-gray-200 rounded w-1/3"></div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {Array.from({ length: 4 }).map((_, i) => (
                  <div key={i} className="h-32 bg-gray-200 rounded-lg"></div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </RequireAuth>
    );
  }

  return (
    <RequireAuth>
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          {/* Success Message */}
          {showSuccessMessage && (
            <div className="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
              <div className="flex items-center gap-3">
                <CheckCircle className="w-5 h-5 text-green-600 dark:text-green-400" />
                <div>
                  <h3 className="text-sm font-semibold text-green-800 dark:text-green-200">
                    Top-up Successful!
                  </h3>
                  <p className="text-sm text-green-700 dark:text-green-300">
                    Your wallet has been successfully topped up. The balance will be updated shortly.
                  </p>
                </div>
                <button
                  onClick={() => setShowSuccessMessage(false)}
                  className="ml-auto text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-200"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
            </div>
          )}

          {/* Header */}
          <div className="mb-6 sm:mb-8">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-2 sm:gap-3">
                  <Wallet className="w-6 h-6 sm:w-8 sm:h-8 text-blue-500" />
                  My Wallet
                </h1>
                <p className="text-sm sm:text-base text-gray-600 dark:text-gray-300 mt-1">
                  Manage your funds and transactions
                </p>
              </div>
              <button
                onClick={() => setShowBalance(!showBalance)}
                className="p-2 sm:p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
              >
                {showBalance ? <EyeOff className="w-4 h-4 sm:w-5 sm:h-5" /> : <Eye className="w-4 h-4 sm:w-5 sm:h-5" />}
              </button>
            </div>
          </div>

          {/* Wallet Summary */}
          {walletSummary && (
            <div className="mb-6 sm:mb-8">
              {/* NGN Wallet - Wholesaler Platform */}
              <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 sm:p-8 text-white">
                <div className="flex items-center justify-between mb-4 sm:mb-6">
                  <div>
                    <h3 className="text-lg sm:text-xl font-semibold">Wallet Balance</h3>
                    <p className="text-green-100 text-sm sm:text-base">Nigerian Naira (NGN)</p>
                  </div>
                  <div className="p-3 sm:p-4 bg-white/20 rounded-lg">
                    <Wallet className="w-6 h-6 sm:w-8 sm:h-8" />
                  </div>
                </div>
                <div className="space-y-2 sm:space-y-3">
                  <div className="text-3xl sm:text-4xl lg:text-5xl font-bold">
                    {showBalance ? formatWalletBalance(walletSummary.ngnWallet.available, "NGN") : "••••••"}
                  </div>
                  <div className="text-green-100 text-sm sm:text-base">
                    Available Balance
                  </div>
                  {walletSummary.ngnWallet.frozen > 0 && (
                    <div className="text-green-100 text-sm">
                      {showBalance ? formatWalletBalance(walletSummary.ngnWallet.frozen, "NGN") : "••••"} frozen
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Quick Actions - Wholesaler Platform */}
          <div className="grid grid-cols-2 gap-3 sm:gap-4 mb-6 sm:mb-8">
            <button
              onClick={() => setShowTopUpModal(true)}
              className="flex flex-col items-center gap-3 sm:gap-4 p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all group"
            >
              <div className="p-3 sm:p-4 bg-green-100 dark:bg-green-900/30 rounded-lg group-hover:bg-green-200 dark:group-hover:bg-green-800/40 transition-colors">
                <Plus className="w-6 h-6 sm:w-8 sm:h-8 text-green-600 dark:text-green-400" />
              </div>
              <span className="text-sm sm:text-base font-semibold text-gray-900 dark:text-white text-center">Top Up Wallet</span>
            </button>

            <button
              onClick={() => setShowExportModal(true)}
              className="flex flex-col items-center gap-3 sm:gap-4 p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all group"
            >
              <div className="p-3 sm:p-4 bg-blue-100 dark:bg-blue-900/30 rounded-lg group-hover:bg-blue-200 dark:group-hover:bg-blue-800/40 transition-colors">
                <Download className="w-6 h-6 sm:w-8 sm:h-8 text-blue-600 dark:text-blue-400" />
              </div>
              <span className="text-sm sm:text-base font-semibold text-gray-900 dark:text-white text-center">Export Transactions</span>
            </button>
          </div>

          {/* Additional Actions */}
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-6 sm:mb-8">
            <button
              onClick={() => window.location.reload()}
              className="flex flex-col items-center gap-2 sm:gap-3 p-3 sm:p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all group"
            >
              <div className="p-2 sm:p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg group-hover:bg-purple-200 dark:group-hover:bg-purple-800/40 transition-colors">
                <RefreshCw className="w-4 h-4 sm:w-5 sm:h-5 text-purple-600 dark:text-purple-400" />
              </div>
              <span className="text-xs sm:text-sm font-medium text-gray-900 dark:text-white text-center">Refresh</span>
            </button>

            <Link
              href="/profile/wallet/analytics"
              className="flex flex-col items-center gap-2 sm:gap-3 p-3 sm:p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all group"
            >
              <div className="p-2 sm:p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg group-hover:bg-blue-200 dark:group-hover:bg-blue-800/40 transition-colors">
                <BarChart3 className="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 dark:text-blue-400" />
              </div>
              <span className="text-xs sm:text-sm font-medium text-gray-900 dark:text-white text-center">Analytics</span>
            </Link>

            <button
              onClick={() => window.location.href = '/profile'}
              className="flex flex-col items-center gap-2 sm:gap-3 p-3 sm:p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all group"
            >
              <div className="p-2 sm:p-3 bg-gray-100 dark:bg-gray-700 rounded-lg group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors">
                <UserPlus className="w-4 h-4 sm:w-5 sm:h-5 text-gray-600 dark:text-gray-400" />
              </div>
              <span className="text-xs sm:text-sm font-medium text-gray-900 dark:text-white text-center">Settings</span>
            </button>

            <button
              onClick={() => setShowExportModal(true)}
              className="flex flex-col items-center gap-2 sm:gap-3 p-3 sm:p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all group"
            >
              <div className="p-2 sm:p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg group-hover:bg-blue-200 dark:group-hover:bg-blue-800/40 transition-colors">
                <Download className="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 dark:text-blue-400" />
              </div>
              <span className="text-xs sm:text-sm font-medium text-gray-900 dark:text-white text-center">Export</span>
            </button>
          </div>

          {/* Enhanced Transaction History */}
          <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
            <div className="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
                <h2 className="text-base sm:text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                  <History className="w-4 h-4 sm:w-5 sm:h-5" />
                  Transaction History
                </h2>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setShowTransactionFilters(!showTransactionFilters)}
                    className="flex items-center gap-2 px-3 py-2 text-xs sm:text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                  >
                    <Filter className="w-3 h-3 sm:w-4 sm:h-4" />
                    Filters
                    <ChevronDown className={`w-3 h-3 sm:w-4 sm:h-4 transition-transform ${showTransactionFilters ? 'rotate-180' : ''}`} />
                  </button>
                  <button
                    onClick={clearFilters}
                    className="px-3 py-2 text-xs sm:text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors"
                  >
                    Clear
                  </button>
                </div>
              </div>

              {/* Transaction Summary */}
              <div className="mt-3 sm:mt-4 grid grid-cols-2 sm:grid-cols-5 gap-2 sm:gap-3">
                <div className="text-center p-2 sm:p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                  <p className="text-lg sm:text-2xl font-bold text-green-600 dark:text-green-400">{transactionSummary.depositCount}</p>
                  <p className="text-xs text-green-600 dark:text-green-400">Deposits</p>
                </div>
                <div className="text-center p-2 sm:p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                  <p className="text-lg sm:text-2xl font-bold text-red-600 dark:text-red-400">{transactionSummary.withdrawalCount}</p>
                  <p className="text-xs text-red-600 dark:text-red-400">Withdrawals</p>
                </div>
                <div className="text-center p-2 sm:p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                  <p className="text-lg sm:text-2xl font-bold text-blue-600 dark:text-blue-400">{transactionSummary.transferCount}</p>
                  <p className="text-xs text-blue-600 dark:text-blue-400">Transfers</p>
                </div>
                <div className="text-center p-2 sm:p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                  <p className="text-lg sm:text-2xl font-bold text-yellow-600 dark:text-yellow-400">{transactionSummary.pendingCount}</p>
                  <p className="text-xs text-yellow-600 dark:text-yellow-400">Pending</p>
                </div>
                <div className="text-center p-2 sm:p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg col-span-2 sm:col-span-1">
                  <p className="text-sm sm:text-2xl font-bold text-purple-600 dark:text-purple-400">
                    {formatCurrency(transactionSummary.totalAmount, 'NGN')}
                  </p>
                  <p className="text-xs text-purple-600 dark:text-purple-400">Net Amount</p>
                </div>
              </div>
            </div>

            {/* Filter Panel */}
            {showTransactionFilters && (
              <div className="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                  {/* Search */}
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-3 h-3 sm:w-4 sm:h-4 text-gray-400" />
                    <input
                      type="text"
                      placeholder="Search transactions..."
                      value={transactionFilters.search}
                      onChange={(e) => handleFilterChange('search', e.target.value)}
                      className="w-full pl-8 sm:pl-10 pr-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                    />
                  </div>

                  {/* Currency */}
                  <select
                    value={transactionFilters.currency}
                    onChange={(e) => handleFilterChange('currency', e.target.value)}
                    className="px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  >
                    <option value="all">All Currencies</option>
                    <option value="NGN">NGN</option>
                    <option value="ATH">ATH</option>
                  </select>

                  {/* Transaction Type */}
                  <select
                    value={transactionFilters.transactionType}
                    onChange={(e) => handleFilterChange('transactionType', e.target.value)}
                    className="px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  >
                    <option value="all">All Types</option>
                    <option value="deposit">Deposit</option>
                    <option value="withdrawal">Withdrawal</option>
                    <option value="transfer">Transfer</option>
                    <option value="payment">Payment</option>
                    <option value="refund">Refund</option>
                    <option value="vendor_payment">Vendor Payment</option>
                  </select>

                  {/* Status */}
                  <select
                    value={transactionFilters.status}
                    onChange={(e) => handleFilterChange('status', e.target.value)}
                    className="px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  >
                    <option value="all">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                  </select>

                  {/* Date Range */}
                  <div className="flex gap-2">
                    <input
                      type="date"
                      value={transactionFilters.startDate}
                      onChange={(e) => handleFilterChange('startDate', e.target.value)}
                      className="flex-1 px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                      placeholder="Start Date"
                    />
                    <input
                      type="date"
                      value={transactionFilters.endDate}
                      onChange={(e) => handleFilterChange('endDate', e.target.value)}
                      className="flex-1 px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                      placeholder="End Date"
                    />
                  </div>

                  {/* Amount Range */}
                  <div className="flex gap-2">
                    <input
                      type="number"
                      value={transactionFilters.minAmount}
                      onChange={(e) => handleFilterChange('minAmount', e.target.value)}
                      className="w-1/2 px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                      placeholder="Min Amount"
                    />
                    <input
                      type="number"
                      value={transactionFilters.maxAmount}
                      onChange={(e) => handleFilterChange('maxAmount', e.target.value)}
                      className="w-1/2 px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                      placeholder="Max Amount"
                    />
                  </div>

                  {/* Sort Options */}
                  <div className="flex gap-2">
                    <select
                      value={transactionFilters.sortBy}
                      onChange={(e) => handleFilterChange('sortBy', e.target.value)}
                      className="flex-1 px-3 py-2 sm:py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                    >
                      <option value="createdAt">Date</option>
                      <option value="amount">Amount</option>
                      <option value="status">Status</option>
                    </select>
                    <button
                      onClick={() => handleFilterChange('sortOrder', transactionFilters.sortOrder === 'asc' ? 'desc' : 'asc')}
                      className="px-3 py-2 sm:py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                    >
                      {transactionFilters.sortOrder === 'asc' ? <SortAsc className="w-3 h-3 sm:w-4 sm:h-4" /> : <SortDesc className="w-3 h-3 sm:w-4 sm:h-4" />}
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div className="p-4 sm:p-6">
              {transactions.length === 0 ? (
                <div className="text-center py-6 sm:py-8">
                  <Wallet className="w-10 h-10 sm:w-12 sm:h-12 text-gray-400 mx-auto mb-3 sm:mb-4" />
                  <p className="text-sm sm:text-base text-gray-500 dark:text-gray-400">No transactions found</p>
                  {Object.values(transactionFilters).some(v => v && v !== 'all') && (
                    <button
                      onClick={clearFilters}
                      className="mt-2 text-sm text-blue-500 hover:text-blue-600 transition-colors"
                    >
                      Clear filters to see all transactions
                    </button>
                  )}
                </div>
              ) : (
                <>
                  <div className="space-y-3 sm:space-y-4">
                    {transactions.map((transaction) => (
                      <div
                        key={transaction._id}
                        onClick={() => {
                          setSelectedTransaction(transaction);
                          setShowTransactionDetails(true);
                        }}
                        className="flex items-center justify-between p-3 sm:p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600/50 transition-colors cursor-pointer"
                      >
                        <div className="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                          <div className="flex-shrink-0">
                            {getTransactionIcon(transaction.type, transaction.category)}
                          </div>
                          <div className="min-w-0 flex-1">
                            <p className="text-sm sm:text-base font-medium text-gray-900 dark:text-white truncate">
                              {transaction.description}
                            </p>
                            <p className="text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                              {new Date(transaction.createdAt).toLocaleDateString()}
                            </p>
                          </div>
                        </div>
                        <div className="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                          <div className="text-right">
                            <p className={`text-sm sm:text-base font-semibold ${transaction.amount > 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {transaction.amount > 0 ? '+' : ''}{formatCurrency(Math.abs(transaction.amount), transaction.currency)}
                            </p>
                            <p className="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">
                              {transaction.reference}
                            </p>
                          </div>
                          <div className="flex-shrink-0">
                            {getStatusIcon(transaction.status)}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* Pagination */}
                  {transactionPagination.pages > 1 && (
                    <div className="mt-4 sm:mt-6 flex flex-col sm:flex-row items-center justify-between gap-3 sm:gap-0">
                      <div className="text-xs sm:text-sm text-gray-500 dark:text-gray-400 text-center sm:text-left">
                        Showing {((transactionPagination.page - 1) * 10) + 1} to {Math.min(transactionPagination.page * 10, transactionPagination.total)} of {transactionPagination.total} transactions
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => handlePageChange(transactionPagination.page - 1)}
                          disabled={transactionPagination.page <= 1}
                          className="p-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                        >
                          <ChevronLeft className="w-3 h-3 sm:w-4 sm:h-4" />
                        </button>
                        <span className="px-2 sm:px-3 py-2 text-xs sm:text-sm text-gray-700 dark:text-gray-300">
                          Page {transactionPagination.page} of {transactionPagination.pages}
                        </span>
                        <button
                          onClick={() => handlePageChange(transactionPagination.page + 1)}
                          disabled={transactionPagination.page >= transactionPagination.pages}
                          className="p-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                        >
                          <ChevronRight className="w-3 h-3 sm:w-4 sm:h-4" />
                        </button>
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>

          {/* Top Up Modal */}
          <Modal
            open={showTopUpModal}
            onClose={() => setShowTopUpModal(false)}
            title="Top Up Wallet"
          >
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Amount (NGN)
                </label>
                <input
                  type="number"
                  value={topUpAmount}
                  onChange={(e) => setTopUpAmount(e.target.value)}
                  placeholder="Enter amount to top up"
                  className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                />
              </div>
              <div className="flex flex-col sm:flex-row gap-3">
                <button
                  onClick={handleTopUp}
                  className="flex-1 bg-blue-500 text-white py-2.5 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium"
                >
                  Proceed to Payment
                </button>
                <button
                  onClick={() => setShowTopUpModal(false)}
                  className="px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium"
                >
                  Cancel
                </button>
              </div>
            </div>
          </Modal>

          {/* Transfer Modal */}
          <Modal
            open={showTransferModal}
            onClose={() => {
              console.log('Closing transfer modal, resetting data');
              setShowTransferModal(false);
              setSearchQuery("");
              setSearchResults([]);
              setSelectedRecipient(null);
              setTransferData({ toUserId: "", amount: "", currency: "NGN", description: "" });
            }}
            title="Transfer Funds"
          >
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Search Recipient
                </label>
                <div className="relative">
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => {
                      setSearchQuery(e.target.value);
                      searchUsers(e.target.value);
                    }}
                    placeholder="Search by @username, email, or wallet ID..."
                    className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  />
                  {isSearching && (
                    <div className="absolute right-3 top-3">
                      <div className="animate-spin rounded-full h-3 w-3 sm:h-4 sm:w-4 border-b-2 border-blue-500"></div>
                    </div>
                  )}
                </div>

                {/* Search Results */}
                {searchResults.length > 0 && (
                  <div className="mt-2 space-y-1 sm:space-y-2 max-h-32 sm:max-h-40 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg">
                    <div className="p-2 text-xs text-gray-500 dark:text-gray-400 bg-yellow-50 dark:bg-yellow-900/20 border-b">
                      Click on a user below to select them as recipient
                    </div>
                    {searchResults.map((user) => (
                      <div
                        key={user._id}
                        onClick={() => {
                          console.log('Selecting recipient:', user);
                          setSelectedRecipient(user);
                          setTransferData({ ...transferData, toUserId: user._id });
                          setSearchQuery(user.displayName || user.username);
                          setSearchResults([]);
                          console.log('Recipient selected, transferData updated');
                        }}
                        className="flex items-center gap-2 sm:gap-3 p-2 sm:p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer"
                      >
                        <div className="w-6 h-6 sm:w-8 sm:h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">
                          {(user.displayName || user.username).charAt(0).toUpperCase()}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="text-sm sm:text-base font-medium text-gray-900 dark:text-white truncate">
                            {user.displayName || user.username}
                          </div>
                          <div className="text-xs sm:text-sm text-gray-500 dark:text-gray-400 truncate">
                            @{user.username} • {user.walletId}
                          </div>
                        </div>
                        {user.isVerified && (
                          <div className="text-green-500 flex-shrink-0">
                            <svg className="w-3 h-3 sm:w-4 sm:h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                            </svg>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* No Results Message */}
                {searchQuery.length >= 2 && searchResults.length === 0 && !isSearching && (
                  <div className="mt-2 p-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg">
                    <div className="text-center text-gray-500 dark:text-gray-400">
                      <p className="text-sm">No users found for "{searchQuery}"</p>
                      <p className="text-xs mt-1">Try searching by username, email, or wallet ID</p>
                    </div>
                  </div>
                )}

                {/* Selected Recipient */}
                {!selectedRecipient && transferData.toUserId === "" && (
                  <div className="mt-2 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                    <div className="flex items-center gap-2 text-red-600 dark:text-red-400">
                      <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                      </svg>
                      <span className="text-sm font-medium">No recipient selected</span>
                    </div>
                    <p className="text-xs text-red-500 dark:text-red-300 mt-1">
                      Search for a user above and click on them to select as recipient
                    </p>
                  </div>
                )}
                {selectedRecipient && (
                  <div className="mt-2 p-2 sm:p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <div className="flex items-center gap-2 sm:gap-3">
                      <div className="w-6 h-6 sm:w-8 sm:h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">
                        {(selectedRecipient.displayName || selectedRecipient.username).charAt(0).toUpperCase()}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="text-sm sm:text-base font-medium text-gray-900 dark:text-white truncate">
                          {selectedRecipient.displayName || selectedRecipient.username}
                        </div>
                        <div className="text-xs sm:text-sm text-gray-500 dark:text-gray-400 truncate">
                          {selectedRecipient.walletId}
                        </div>
                      </div>
                      <div className="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                        <button
                          onClick={async () => {
                            try {
                              await apiPost("/api/v1/wallets/contacts", {
                                contactUserId: selectedRecipient._id
                              });
                              toast("Added to contacts!", "success");
                            } catch (error) {
                              console.error("Error adding contact:", error);
                              toast("Failed to add contact", "error");
                            }
                          }}
                          className="px-2 sm:px-3 py-1 bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs rounded-lg hover:bg-green-200 dark:hover:bg-green-900/30 transition-colors"
                          title="Add to contacts"
                        >
                          <UserPlus className="w-3 h-3 inline mr-1" />
                          <span className="hidden sm:inline">Add</span>
                        </button>
                        <button
                          onClick={() => {
                            setSelectedRecipient(null);
                            setTransferData({ ...transferData, toUserId: "" });
                            setSearchQuery("");
                          }}
                          className="text-gray-400 hover:text-gray-600 p-1"
                          title="Remove recipient"
                        >
                          <svg className="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Currency
                </label>
                <select
                  value={transferData.currency}
                  onChange={(e) => setTransferData({ ...transferData, currency: e.target.value as "ATH" | "NGN" })}
                  className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                >
                  <option value="NGN">NGN (Nigerian Naira)</option>
                  <option value="ATH">ATH (Platform Token)</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Amount
                </label>
                <input
                  type="number"
                  value={transferData.amount}
                  onChange={(e) => setTransferData({ ...transferData, amount: e.target.value })}
                  placeholder="Enter amount to transfer"
                  className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Description (Optional)
                </label>
                <input
                  type="text"
                  value={transferData.description}
                  onChange={(e) => setTransferData({ ...transferData, description: e.target.value })}
                  placeholder="Enter transfer description"
                  className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                />
              </div>
              <div className="flex flex-col sm:flex-row gap-3">
                <button
                  onClick={debouncedHandleTransferWithValidation}
                  disabled={isTransferring || validationInProgressRef.current}
                  className={`flex-1 py-2.5 px-4 rounded-lg transition-colors text-sm font-medium ${isTransferring || validationInProgressRef.current
                    ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                    : 'bg-blue-500 text-white hover:bg-blue-600'
                    }`}
                >
                  {isTransferring ? 'Transferring...' : validationInProgressRef.current ? 'Validating...' : 'Transfer Funds'}
                </button>
                <button
                  onClick={() => setShowTransferModal(false)}
                  className="px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium"
                >
                  Cancel
                </button>
              </div>
            </div>
          </Modal>
        </div>

        {/* QR Code Generator Modal */}
        {showQRGenerator && userWalletId && (
          <QRCodeGenerator
            walletId={userWalletId}
            displayName={userDisplayName}
            onClose={() => setShowQRGenerator(false)}
          />
        )}

        {/* QR Code Scanner Modal */}
        {showQRScanner && (
          <QRCodeScanner
            onScan={handleQRScan}
            onClose={() => setShowQRScanner(false)}
          />
        )}

        {/* Contact Manager Modal */}
        {showContactManager && (
          <ContactManager
            onSelectContact={handleContactSelect}
            onClose={() => setShowContactManager(false)}
          />
        )}

        {/* Transaction Validator Modal */}
        {showTransactionValidator && transferData.toUserId && transferData.amount && (
          <TransactionValidator
            recipientId={transferData.toUserId}
            amount={transferData.currency === "NGN" ? Math.round(parseFloat(transferData.amount) * 100) : parseFloat(transferData.amount)}
            currency={transferData.currency}
            onValidationComplete={handleValidationComplete}
            onClose={() => setShowTransactionValidator(false)}
          />
        )}

        {/* Export Modal */}
        {showExportModal && (
          <Modal open={true} onClose={() => setShowExportModal(false)} title="Export Transactions">
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Format
                  </label>
                  <select
                    value={exportFormat}
                    onChange={(e) => setExportFormat(e.target.value)}
                    className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  >
                    <option value="csv">CSV</option>
                    <option value="excel">Excel</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Transaction Type
                  </label>
                  <select
                    value={exportType}
                    onChange={(e) => setExportType(e.target.value)}
                    className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  >
                    <option value="all">All Types</option>
                    <option value="deposit">Deposits</option>
                    <option value="withdrawal">Withdrawals</option>
                    <option value="transfer">Transfers</option>
                    <option value="payment">Payments</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Currency
                  </label>
                  <select
                    value={exportCurrency}
                    onChange={(e) => setExportCurrency(e.target.value)}
                    className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  >
                    <option value="all">All Currencies</option>
                    <option value="NGN">NGN</option>
                    <option value="ATH">ATH</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    End Date
                  </label>
                  <input
                    type="date"
                    value={exportEndDate}
                    onChange={(e) => setExportEndDate(e.target.value)}
                    className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Start Date
                </label>
                <input
                  type="date"
                  value={exportStartDate}
                  onChange={(e) => setExportStartDate(e.target.value)}
                  className="w-full px-3 py-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                />
              </div>
              <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4">
                <button
                  onClick={() => setShowExportModal(false)}
                  className="px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium"
                >
                  Cancel
                </button>
                <button
                  onClick={handleExportTransactions}
                  className="px-4 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2 text-sm font-medium"
                >
                  <Download className="w-3 h-3 sm:w-4 sm:h-4" />
                  Export
                </button>
              </div>
            </div>
          </Modal>
        )}

        {/* Transaction Details Modal */}
        {showTransactionDetails && selectedTransaction && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-3 sm:p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto shadow-xl">
              {/* Header */}
              <div className="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-blue-100 dark:bg-blue-900/20 rounded-lg">
                    {getTransactionIcon(selectedTransaction.type, selectedTransaction.category)}
                  </div>
                  <div>
                    <h3 className="text-base sm:text-lg font-semibold text-gray-900 dark:text-white">
                      Transaction Details
                    </h3>
                    <p className="text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                      {selectedTransaction.reference}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => setShowTransactionDetails(false)}
                  className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                >
                  <X className="w-4 h-4 sm:w-5 sm:h-5 text-gray-500" />
                </button>
              </div>

              {/* Content */}
              <div className="p-4 sm:p-6 space-y-4 sm:space-y-6">
                {/* Amount */}
                <div className="text-center">
                  <p className="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-1">
                    {selectedTransaction.amount > 0 ? '+' : ''}{formatCurrency(Math.abs(selectedTransaction.amount), selectedTransaction.currency)}
                  </p>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    {selectedTransaction.description}
                  </p>
                </div>

                {/* Status */}
                <div className="flex items-center justify-center">
                  <div className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium ${selectedTransaction.status === 'completed'
                    ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'
                    : selectedTransaction.status === 'pending'
                      ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400'
                      : 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400'
                    }`}>
                    {getStatusIcon(selectedTransaction.status)}
                    <span className="capitalize">{selectedTransaction.status}</span>
                  </div>
                </div>

                {/* Details Grid */}
                <div className="grid grid-cols-1 gap-3 sm:gap-4">
                  <div className="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Type</span>
                    <span className="text-sm font-medium text-gray-900 dark:text-white capitalize">
                      {selectedTransaction.type}
                    </span>
                  </div>

                  <div className="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Category</span>
                    <span className="text-sm font-medium text-gray-900 dark:text-white capitalize">
                      {selectedTransaction.category}
                    </span>
                  </div>

                  <div className="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Currency</span>
                    <span className="text-sm font-medium text-gray-900 dark:text-white">
                      {selectedTransaction.currency}
                    </span>
                  </div>

                  <div className="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Date</span>
                    <span className="text-sm font-medium text-gray-900 dark:text-white">
                      {new Date(selectedTransaction.createdAt).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </span>
                  </div>

                  <div className="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Reference</span>
                    <span className="text-sm font-medium text-gray-900 dark:text-white font-mono">
                      {selectedTransaction.reference}
                    </span>
                  </div>

                  <div className="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Balance Before</span>
                    <span className="text-sm font-medium text-gray-900 dark:text-white">
                      {formatCurrency(selectedTransaction.balanceBefore, selectedTransaction.currency)}
                    </span>
                  </div>

                  <div className="flex justify-between items-center py-2">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Balance After</span>
                    <span className="text-sm font-medium text-gray-900 dark:text-white">
                      {formatCurrency(selectedTransaction.balanceAfter, selectedTransaction.currency)}
                    </span>
                  </div>
                </div>

                {/* Actions */}
                <div className="flex gap-3 pt-4">
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(selectedTransaction.reference);
                      toast('Reference copied to clipboard', 'success');
                    }}
                    className="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm font-medium"
                  >
                    Copy Reference
                  </button>
                  <button
                    onClick={() => setShowTransactionDetails(false)}
                    className="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </RequireAuth>
  );
}

export default function WalletPage() {
  return (
    <Suspense fallback={
      <RequireAuth>
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
          <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div className="animate-pulse space-y-6">
              <div className="h-8 bg-gray-200 rounded w-1/3"></div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {Array.from({ length: 4 }).map((_, i) => (
                  <div key={i} className="h-32 bg-gray-200 rounded-lg"></div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </RequireAuth>
    }>
      <WalletPageContent />
    </Suspense>
  );
}
